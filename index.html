<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pets Simple Front</title>
    <style>
        * {
            font-family: sans-serif;
            background-color: gainsboro;
        }

        .title {
            text-align: center;
        }

        #remote-media-div {
            max-width: 300px;

            margin-right: auto;
            margin-left: auto;
            border-radius: 8px;
        }

        #remote-media-div video {
            background-color: white;
            width: 100%;
            padding: 8px;
        }
    </style>
</head>

<body>
    <h1 class="title">Video Conference</h1>
    <div id="remote-media-div"></div>
    <script src="//sdk.twilio.com/js/video/releases/2.17.1/twilio-video.min.js"></script>
    <script>
        const Video = Twilio.Video;
        const { connect, createLocalTracks } = Video;

        const ACCESS_TOKEN = localStorage.getItem('ACCESS_TOKEN');

        connect(ACCESS_TOKEN, { name: 'my-new-room' })
            .then(
                room => {
                    console.log(`Successfully joined a Room: ${room}`);

                    // Log your Client's LocalParticipant in the Room
                    const localParticipant = room.localParticipant;
                    console.log(`Connected to the Room as LocalParticipant "${localParticipant.identity}"`);

                    room.on('participantConnected', participant => {
                        console.log(`Participant connected: ${participant.identity}`);
                    });

                    room.on('participantDisconnected', participant => {
                        console.log(`Participant disconnected: ${participant.identity}`);
                    });

                    // Log any Participants already connected to the Room

                    console.log('[bcd] room.participants:', room.participants);

                    room.participants.forEach(participant => {
                        // console.log(`Participant "${participant.identity}" is connected to the Room`);

                        participant.tracks.forEach(publication => {
                            if (publication.track) {
                                console.log('[bcd] 1');
                                document.getElementById('remote-media-div').appendChild(publication.track.attach());

                            }
                        });

                        participant.on('trackSubscribed', track => {

                            console.log('[bcd] 2');
                            console.log('[bcd] track:', track);
                            document.getElementById('remote-media-div').appendChild(track.attach());

                        });
                    });

                    // Log new Participants as they connect to the Room
                    room.once('participantConnected', participant => {
                        console.log(`Participant "${participant.identity}" has connected to the Room`);
                    });

                    // Log Participants as they disconnect from the Room
                    room.once('participantDisconnected', participant => {
                        // console.log(`Participant "${participant.identity}" has disconnected from the Room`);
                        console.log(`Participant "${participant.identity}" connected`);

                        participant.tracks.forEach(publication => {
                            // console.log('[bcd] publication.isSubscribed:', publication.isSubscribed);

                            if (publication.isSubscribed) {
                                console.log('[bcd] 3');
                                const track = publication.track;
                                document.getElementById('remote-media-div').appendChild(track.attach());

                            }
                        });

                        participant.on('trackSubscribed', track => {
                            console.log('[bcd] 4');
                            document.getElementById('remote-media-div').appendChild(track.attach());

                        });
                    });

                },
                error => {
                    console.error(`Unable to connect to Room: ${error.message}`);
                });


    </script>
</body>

</html>